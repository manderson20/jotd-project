<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JOTD Widget</title>
  <style>
    :root {
      --bg: #ffffff;
      --fg: #111111;
      --muted: #666666;
      --border: rgba(0,0,0,0.12);
      --shadow: rgba(0,0,0,0.06);
      --link: #0b63ce;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --radius: 14px;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f1115;
        --fg: #f3f4f6;
        --muted: #a7a7a7;
        --border: rgba(255,255,255,0.16);
        --shadow: rgba(0,0,0,0.35);
        --link: #7ab7ff;
      }
    }

    html, body { margin:0; padding:0; background: transparent; }
    body { font-family: var(--font); color: var(--fg); }

    .card {
      box-sizing: border-box;
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 6px 18px var(--shadow);
      padding: 14px 14px 12px 14px;
    }

    .top {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .title {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: .02em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .meta {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 60%;
      text-align: right;
    }

    .text {
      font-size: 18px;
      line-height: 1.35;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .actions {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-top: 10px;
    }

    .btn {
      appearance:none;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--link);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
    }

    .btn:hover { filter: brightness(0.95); }

    .small {
      font-size: 12px;
      color: var(--muted);
    }

    .error {
      color: #b00020;
      font-size: 14px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="card" id="card">
    <div class="top">
      <div class="title" id="title">Joke of the Day</div>
      <div class="meta" id="meta">Loading…</div>
    </div>

    <div class="text" id="text">Loading…</div>

    <div class="actions">
      <div class="small" id="foot"></div>
      <button class="btn" id="moreBtn" style="display:none;">More</button>
    </div>

    <div class="error" id="err" style="display:none;"></div>
  </div>

<script>
  // -----------------------------
  // Config via query params
  // -----------------------------
  // api = override API base (optional)
  // maxChars = truncate length (optional)
  // ratings = allowed ratings, e.g. G,PG
  // categories = optional filter
  // title = override card title
  // embedId = unique id used for auto-resize when multiple widgets exist
  // parentOrigin = optional security: expected parent origin for postMessage target
  const qp = new URLSearchParams(location.search);

  const API_BASE = qp.get("api") || "https://joke-api.mthwanderson20.workers.dev";
  const maxChars = qp.get("maxChars"); // API handles truncation
  const ratings = qp.get("ratings") || "G,PG";
  const categories = qp.get("categories"); // optional
  const title = qp.get("title") || "Joke of the Day";

  const embedId = qp.get("embedId") || "jotd";
  const parentOrigin = qp.get("parentOrigin") || "*"; // keep "*" for universal embeds

  document.getElementById("title").textContent = title;

  const metaEl = document.getElementById("meta");
  const textEl = document.getElementById("text");
  const footEl = document.getElementById("foot");
  const errEl = document.getElementById("err");
  const moreBtn = document.getElementById("moreBtn");

  let fullText = "";

  // -----------------------------
  // Auto-resize (postMessage)
  // -----------------------------
  function measureHeight() {
    return Math.max(
      document.body.scrollHeight,
      document.documentElement.scrollHeight,
      document.body.offsetHeight,
      document.documentElement.offsetHeight,
      document.documentElement.clientHeight
    );
  }

  function postResize(reason) {
    try {
      parent.postMessage(
        { type: "jotd:resize", embedId, height: measureHeight(), reason: reason || "update" },
        parentOrigin
      );
    } catch {}
  }

  // Post on load
  window.addEventListener("load", () => postResize("load"));

  // Post on any layout/content change
  const ro = new ResizeObserver(() => postResize("resize_observer"));
  ro.observe(document.documentElement);

  // -----------------------------
  // UI helpers
  // -----------------------------
  function showError(msg) {
    errEl.style.display = "";
    errEl.textContent = msg;
    metaEl.textContent = "Error";
    textEl.textContent = "";
    footEl.textContent = "";
    moreBtn.style.display = "none";
    postResize("error");
  }

  function buildUrl() {
    const u = new URL(API_BASE.replace(/\/+$/, "") + "/v1/joke/today");
    u.searchParams.set("ratings", ratings);
    if (categories) u.searchParams.set("categories", categories);
    if (maxChars) u.searchParams.set("maxChars", maxChars);
    return u.toString();
  }

  async function load() {
    try {
      const res = await fetch(buildUrl(), { cache: "no-store" });
      const data = await res.json();

      if (!res.ok) throw new Error(JSON.stringify(data, null, 2));
      if (!data || !data.joke) throw new Error("No joke returned. Check filters (ratings/categories) and active flags.");

      const joke = data.joke;

      // Prefer API-provided displayText (truncate handled server-side)
      const display = (joke.displayText || joke.text || "").trim();
      fullText = (joke.text || "").trim();

      textEl.textContent = display;

      // Meta line
      const bits = [];
      if (joke.category) bits.push(joke.category);
      if (joke.rating) bits.push(joke.rating);
      metaEl.textContent = bits.join(" • ") || "—";

      // Footer: date if present
      footEl.textContent = data.date ? data.date : "";

      const isTruncated = !!joke.isTruncated || (maxChars && fullText && display !== fullText);
      moreBtn.style.display = isTruncated ? "" : "none";

      // Post resize after render
      postResize("loaded");
    } catch (e) {
      showError(String(e?.message || e));
    }
  }

  moreBtn.addEventListener("click", () => {
    textEl.textContent = fullText || textEl.textContent;
    moreBtn.style.display = "none";
    postResize("expanded");
  });

  load();
</script>
</body>
</html>
